/********************************************************************
 * Copyright (C) 2016 上海洋码头网络技术有限公司. All Rights Reserved.
 *
 * @author tongliang
 * @email tongliang@ymatou.com
 * @date 2016/4/26
 *
 ********************************************************************
 */

'use strict';

var md5 = require('md5');
var assignIn = require('lodash.assignin');
var assert = require('assert');

/**
 * 格式化object中的array为object
 * @param obj
 * @returns {*}
 */
var formatArrayToObject = function (obj) {
    if (!obj) {
        return obj;
    }
    var keyArray = Object.keys(obj);
    for (var i = 0; i < keyArray.length; i++) {
        var item = keyArray[i];
        if (Array.isArray(obj[item])) {
            for (var m = 0; m < obj[item].length; m++) {
                if (typeof obj[item][m] === 'object') {
                    obj[item + '[' + m + ']'] = JSON.stringify(obj[item][m]);
                }
                else {
                    obj[item + '[' + m + ']'] = obj[item][m].toString();
                }
            }
            delete obj[item];
        }
    }
    return obj;
};

/**
 * obj 转 string
 * @param obj
 * @returns {string}
 */
var objToString = function (obj) {
    assert(typeof obj === 'object', 'obj should be object');
    assert(!Array.isArray(obj), 'obj should not be array');
    var returnStr = '';
    obj = formatArrayToObject(obj);
    var keyArray = Object.keys(obj);
    keyArray.sort();
    for (var i = 0; i < keyArray.length; i++) {
        var item = keyArray[i];
        if (typeof obj[item] === 'string' || typeof obj[item] === 'number') {
            returnStr += item + obj[item].toString();
        }
        if (typeof obj[item] === 'object') {
            //参数是array
            if (Array.isArray(obj[item])) {
                for (var m = 0; m < obj[item].length; m++) {
                    if (typeof obj[item][m] === 'object') {
                        returnStr += item + '[' + m + ']' + JSON.stringify(obj[item][m]);
                    } else {
                        returnStr += item + '[' + m + ']' + obj[item][m];
                    }
                }
            } else {
                //参数是object
                returnStr += item + JSON.stringify(obj[item]);
            }
        }
    }
    return returnStr;
};

module.exports = function (signObj, secret) {
    assert(typeof secret === 'string', 'secret should be string');
    //若为array自动转成obj
    if (Array.isArray(signObj)) {
        signObj = assignIn.apply(null, signObj);
    }
    var signStrBefore = objToString(signObj);
    var signStr = md5(secret + signStrBefore + secret);
    return signStr;
};

//解决 swift的JSON 和 js的JSON对 '/'的解析不兼容的问题
//swift 对 '/' stringify = '\/'
//js 对 '/' stringify = '/'
//导致签名不通过
module.exports.getCompatibleSign = function (signObj, secret) {
    assert(typeof secret === 'string', 'secret should be string');
    //若为array自动转成obj
    if (Array.isArray(signObj)) {
        signObj = assignIn.apply(null, signObj);
    }
    var signStrBefore = objToString(signObj);
    signStrBefore = signStrBefore.replace(/\//g, '\\/');
    var signStr = md5(secret + signStrBefore + secret);
    return signStr;
};