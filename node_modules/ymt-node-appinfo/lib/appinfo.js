/********************************************************************
 * Copyright (C) 2016 上海洋码头网络技术有限公司. All Rights Reserved.
 *
 * @author tongliang
 * @email tongliang@ymatou.com
 * @date 2016/3/16
 *
 ********************************************************************
 */

'use strict';

var querystring = require('querystring');

module.exports = function () {
  return function (req, res, next) {
    var appInfo = {};
    if (!req.headers) req.headers = {};
    appInfo.appKey = req.headers['app-key'] || req.headers['App-Key'] || req.headers['app_key'] || '';
    appInfo.appVersion = req.headers['app-version'] || req.headers['App-Version'] || req.headers['app_version'] || '';
    appInfo.deviceId = req.headers['deviceid'] || req.headers['Deviceid'] || '';
    appInfo.acceptVersion = req.headers['accept-version'] || req.headers['Accept-Version'] || '';

    try {
      var ymtParams = querystring.parse(req.headers['ymt-pars'] || req.headers['Ymt-Pars'] || req.headers['ymt_pars'] || '');
    } catch (e) {
      ymtParams = {};
    }

    appInfo.accessToken = ymtParams.accesstoken || '';   //登录令牌
    appInfo.format = ymtParams.format || '';             //api结果的响应格式
    appInfo.idfa = ymtParams.idfa || '';                 //ios的IDFA
    appInfo.imei = ymtParams.imei || '';                 //android的IMEI
    appInfo.network = ymtParams.network || '';           //网络,wifi,3g,4g
    appInfo.client = ymtParams.client || '';             //客户端,ios,android,h5
    appInfo.type = ymtParams.type || '';                 //app类型,buyer,seller
    appInfo.channel = ymtParams.channel || '';           //渠道
    appInfo.os = ymtParams.os || '';                     //客户端操作系统
    appInfo.userId = Number(ymtParams.userid);           //用户UserID
    if (isNaN(appInfo.userId)) appInfo.userId = 0;
    appInfo.yId = ymtParams.yid || '';                   //搜索所需的yid
    appInfo.requestId = ymtParams.requestid || uuid();       //请求id
    appInfo.appName = ymtParams.appname || '';           //app名称

    if (req.connection) {
      appInfo.clientIp = req.headers['x-forwarded-for'] || req.connection.remoteAddress;
      appInfo.clientPort = req.connection.remotePort;
      //删除ipV4前缀 ::ffff:
      if (appInfo.clientIp && appInfo.clientIp.length <= 22) {
        appInfo.clientIp = appInfo.clientIp.replace('::ffff:', '');
      }
    }
    req.appInfo = appInfo;
    next();
  };
};

function uuid() {
  var d = Date.now();
  var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
    var r = (d + Math.random() * 16) % 16 | 0;
    d = Math.floor(d / 16);
    return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
  return uuid;
}